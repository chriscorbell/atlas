<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} - {{ .Site.Title }}{{ end }}</title>
    <meta name="description"
        content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <script>
        document.documentElement.classList.remove('no-js');
        document.documentElement.classList.add('has-js');
    </script>
    {{ $styles := resources.Get "styles.css" }}
    <link rel="stylesheet" href="{{ $styles.Permalink }}" />
</head>

<body>
    <header class="site-header">
        <div class="container header-inner">
            <a href="{{ "/" | relURL }}" class="logo">Atlas</a>
            <nav class="primary-nav" aria-label="Main navigation">
                <a href="{{ "/" | relURL }}">Home</a>
                <a href="{{ "/blueprint/01-foundation" | relURL }}">Blueprint</a>
            </nav>
        </div>
    </header>

    <main>
        {{ block "main" . }}{{ end }}
    </main>

    {{ $lightbox := resources.Get "lightbox.js" | resources.Minify }}
    <script src="{{ $lightbox.Permalink }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('pre').forEach(function (pre) {
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.textContent = 'Copy';
                button.setAttribute('aria-label', 'Copy code to clipboard');

                button.addEventListener('click', async function () {
                    const code = pre.querySelector('code');
                    const text = code ? code.textContent : pre.textContent;

                    try {
                        await navigator.clipboard.writeText(text);
                        button.textContent = 'Copied!';
                        button.classList.add('copied');

                        setTimeout(function () {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                    }
                });

                pre.appendChild(button);

                const syncButtonPosition = function () {
                    const offset = pre.scrollLeft;
                    button.style.transform = 'translateX(' + offset + 'px)';
                };

                syncButtonPosition();
                pre.addEventListener('scroll', syncButtonPosition, { passive: true });
            });

            const sidebarToggle = document.querySelector('[data-blueprint-toggle]');
            const sidebar = document.querySelector('[data-blueprint-sidebar]');
            if (sidebar && sidebarToggle) {
                const overlay = document.querySelector('[data-blueprint-overlay]');
                const desktopQuery = window.matchMedia('(min-width: 768px)');
                let isOpen = false;
                let previousFocus = null;

                const applyState = function () {
                    const isDesktop = desktopQuery.matches;
                    if (isDesktop) {
                        isOpen = false;
                        sidebar.removeAttribute('aria-hidden');
                        sidebarToggle.setAttribute('aria-expanded', 'false');
                        if (overlay) {
                            overlay.hidden = true;
                        }
                        document.body.classList.remove('is-blueprint-sidebar-open');
                        document.removeEventListener('keydown', handleKeydown);
                        previousFocus = null;
                        return;
                    }

                    sidebar.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
                    sidebarToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');

                    if (overlay) {
                        overlay.hidden = !isOpen;
                    }

                    if (isOpen) {
                        document.body.classList.add('is-blueprint-sidebar-open');
                        document.addEventListener('keydown', handleKeydown);
                    } else {
                        document.body.classList.remove('is-blueprint-sidebar-open');
                        document.removeEventListener('keydown', handleKeydown);
                    }
                };

                const focusFirstInteractive = function () {
                    const focusTarget = sidebar.querySelector('a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])');
                    const elementToFocus = focusTarget instanceof HTMLElement ? focusTarget : sidebar;
                    elementToFocus.focus({ preventScroll: true });
                };

                const openSidebar = function () {
                    if (desktopQuery.matches || isOpen) {
                        return;
                    }
                    previousFocus = document.activeElement instanceof HTMLElement ? document.activeElement : sidebarToggle;
                    isOpen = true;
                    applyState();
                    window.requestAnimationFrame(function () {
                        focusFirstInteractive();
                    });
                };

                const closeSidebar = function (options) {
                    const settings = Object.assign({ restoreFocus: true }, options);
                    if (!isOpen && !desktopQuery.matches) {
                        applyState();
                        if (settings.restoreFocus && settings.restoreFocus !== false) {
                            sidebarToggle.focus({ preventScroll: true });
                        }
                        return;
                    }

                    isOpen = false;
                    applyState();

                    if (settings.restoreFocus && previousFocus && typeof previousFocus.focus === 'function') {
                        previousFocus.focus({ preventScroll: true });
                    } else if (settings.restoreFocus) {
                        sidebarToggle.focus({ preventScroll: true });
                    }

                    previousFocus = null;
                };

                function handleKeydown(event) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        closeSidebar();
                    }
                }

                sidebarToggle.addEventListener('click', function () {
                    if (isOpen) {
                        closeSidebar();
                    } else {
                        openSidebar();
                    }
                });

                if (overlay) {
                    overlay.addEventListener('click', function () {
                        closeSidebar();
                    });
                }

                sidebar.querySelectorAll('a[href]').forEach(function (link) {
                    link.addEventListener('click', function () {
                        closeSidebar({ restoreFocus: false });
                    });
                });

                desktopQuery.addEventListener('change', function () {
                    applyState();
                });

                applyState();
            }

            // Trigger lightweight staggered appear animations once DOM is ready.
            const appearElements = Array.from(document.querySelectorAll('[data-appear]'));
            if (appearElements.length) {
                document.body.classList.add('is-appear-ready');
                const groups = new Map();

                window.requestAnimationFrame(function () {
                    appearElements.forEach(function (element) {
                        const group = element.getAttribute('data-appear-group') || 'default';
                        const index = groups.get(group) || 0;
                        element.style.setProperty('--stagger-index', String(index));

                        const delayAttr = element.getAttribute('data-appear-delay');
                        if (delayAttr !== null) {
                            const delayValue = Number(delayAttr);
                            if (!Number.isNaN(delayValue)) {
                                element.style.setProperty('--appear-delay', delayValue + 'ms');
                            }
                        }

                        groups.set(group, index + 1);
                        element.classList.add('is-visible');
                    });
                });
            }
        });
    </script>
</body>

</html>